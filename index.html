<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokumentasi Kinerja Transmisi dan Instalasi</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007BFF">
    
    <style>
        /* CSS yang sudah ada */
        body { font-family: 'Times New Roman', Times, serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1, .header h2, .header h3 { margin: 0; font-weight: bold; }
        .header h1 { font-size: 18px; }
        .header h2 { font-size: 20px; }
        .header h3 { font-size: 20px; margin-bottom: 15px; min-height: 24px; }
        .header p { text-align: left; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; border: 2px solid black; }
        th, td { border: 2px solid black; padding: 8px; text-align: center; vertical-align: top; }
        thead th { background-color: #e0e0e0; font-weight: bold; }
        .image-cell img { max-width: 100%; height: auto; display: block; margin: 0 auto; max-height: 250px; object-fit: cover; background-color: #f0f0f0; }
        .details-cell { text-align: left; padding: 0; vertical-align: top; }
        .details-table { width: 100%; border: none; }
        .details-table td { border: none; padding: 2px 8px; font-family: 'Times New Roman', Times, serif; font-size: 16px; vertical-align: top; text-align: left; }
        .details-table .label-col { width: 180px; }
        .details-table .colon-col { width: 10px; }
        .form-container { margin-top: 20px; padding: 20px; border: 2px solid #ccc; border-radius: 8px; background-color: #f9f9f9; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-save { background-color: #4CAF50; color: white; }
        .btn-cancel { background-color: #f44336; color: white; }
        .btn-location { background-color: #17a2b8; color: white; margin-bottom: 15px; }
        #print-button { background-color: #007BFF; color: white; margin-top: 20px; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .number-cell.editable { cursor: pointer; color: #007bff; font-weight: bold; text-decoration: underline; }
        .number-cell.editable:hover { background-color: #e9ecef; }
        .image-preview { margin-bottom: 10px; }
        .image-preview img { max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        .input-group input { flex-grow: 1; }
        .input-group button { flex-shrink: 0; margin-bottom: 0; }
        nav.no-print { display: flex; gap: 1px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .nav-link { padding: 10px 20px; text-decoration: none; color: #007BFF; border-radius: 5px 5px 0 0; font-weight: bold; border: 1px solid transparent; background-color: #f0f0f0; border-bottom: none; }
        .nav-link:hover { background-color: #dbeeff; }
        .nav-link.active { background-color: white; color: #333; border-color: #e0e0e0; border-bottom: 2px solid white; position: relative; top: 2px; }
        .hidden { display: none !important; }
        .btn-share-wa { background-color: #25D366; color: white; font-size: 14px; padding: 5px 10px; margin-bottom: 0; font-family: Arial, sans-serif; font-weight: bold; }
        .btn-share-wa:hover { background-color: #128C7E; }
        .table-scroll-wrapper { overflow-x: auto; max-width: 100%; }
        #kegiatan-table { min-width: 900px; }

        @media print {
            @page { size: A4; margin: 1cm; }

            body, .container { background-color: #fff; margin: 0; padding: 0; box-shadow: none; font-size: 12pt; }
            
            /* === PERBAIKAN MASALAH CETAK (MULAI) === */
            .no-print, #form-view, #print-button, .image-preview {
                display: none !important;
            }
            .table-scroll-wrapper {
                overflow-x: visible; /* Pastikan pembungkus tidak menyembunyikan tabel */
            }
            #kegiatan-table {
                min-width: 100%; /* Kembalikan lebar tabel ke normal saat cetak */
            }
            /* === PERBAIKAN MASALAH CETAK (SELESAI) === */

            .number-cell { vertical-align: middle; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            .image-cell img { max-height: 140px; }
            th, td { padding: 4px; }
            .details-table td { font-size: 11pt; padding: 1px 4px; }
            #kegiatan-list > tr:nth-child(6n):not(:last-child) { page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="no-print">
            <a href="#" class="nav-link active" data-target="report-view">Lihat Laporan</a>
            <a href="#" class="nav-link" data-target="form-view">Tambah Data Baru</a>
        </nav>
        <div id="report-view" class="view">
            <div class="header">
                <h1>LAMPIRAN</h1>
                <h2>DOKUMENTASI KINERJA SUB BAGIAN TRANSMISI DAN INSTALASI</h2>
                <h3 id="dynamic-date-range"></h3>
                <p>Berdasarkan Rekap Agenda Very Panggalo terkait Kegiatan sehari-hari tim perawatan dilapangan, berikut lampiran Dokumentasi Rehab Transmisi dan Instalasi.</p>
            </div>
            <div class="table-scroll-wrapper">
                <table id="kegiatan-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">NO</th>
                            <th style="width: 31.6%;">SEBELUM PEKERJAAN</th>
                            <th style="width: 31.6%;">SEMENTARA PEKERJAAN</th>
                            <th style="width: 31.6%;">PEKERJAAN SELESAI</th>
                        </tr>
                    </thead>
                    <tbody id="kegiatan-list"></tbody>
                </table>
            </div>
            <button id="print-button" class="no-print">Cetak Laporan</button>
        </div>
        <div id="loading-status" style="text-align: center; padding: 20px;">Memuat database...</div>
        <div id="form-view" class="form-container view hidden">
            <h2 id="form-title">Tambah Data Kegiatan</h2>
            <form id="kegiatan-form">
                <input type="hidden" id="kegiatan-id">
                <div class="form-group">
                    <label for="tanggal">Tanggal:</label>
                    <input type="date" id="tanggal">
                </div>
                <div class="form-group">
                    <label for="nama-kegiatan">Nama Kegiatan:</label>
                    <input type="text" id="nama-kegiatan" placeholder="Contoh: Pengangkatan pompa air baku...">
                </div>
                <div class="form-group">
                    <label for="lokasi">Lokasi (Deskripsi):</label>
                    <input type="text" id="lokasi" placeholder="Contoh: IPA Pasele dekat Pong Buri'">
                </div>
                <hr>
                <button type="button" id="get-location-btn" class="btn-location">Dapatkan Lokasi Saat Ini</button>
                <div id="location-status" style="font-style: italic; margin-bottom: 10px;"></div>
                <div class="form-group">
                    <label for="lokasi-lengkap">Titik Koordinat & Alamat Lengkap:</label>
                    <input type="text" id="lokasi-lengkap" readonly>
                </div>
                <input type="hidden" id="titik-koordinat"><input type="hidden" id="desa"><input type="hidden" id="kelurahan"><input type="hidden" id="kecamatan"><input type="hidden" id="kabupaten">
                <hr>
                <div class="form-group">
                    <label for="petugas">Petugas:</label>
                    <div class="input-group">
                        <input type="text" id="petugas" placeholder="Contoh: Simri, Very, Leman...">
                        <button type="button" id="btn-isi-personil-lengkap" class="btn-location">Personil Lengkap</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Foto Sebelum</label>
                    <div id="preview-sebelum" class="image-preview"></div>
                    <div class="form-buttons">
                        <button type="button" class="btn-location btn-camera" data-target-input="foto-sebelum">Ambil Foto (Kamera)</button>
                        <button type="button" class="btn-location btn-gallery" data-target-input="foto-sebelum">Pilih dari Galeri</button>
                    </div>
                    <input type="file" id="foto-sebelum" accept="image/*" style="display: none;">
                </div>
                <div class="form-group">
                    <label>Foto Sementara</label>
                    <div id="preview-sementara" class="image-preview"></div>
                    <div class="form-buttons">
                        <button type="button" class="btn-location btn-camera" data-target-input="foto-sementara">Ambil Foto (Kamera)</button>
                        <button type="button" class="btn-location btn-gallery" data-target-input="foto-sementara">Pilih dari Galeri</button>
                    </div>
                    <input type="file" id="foto-sementara" accept="image/*" style="display: none;">
                </div>
                <div class="form-group">
                    <label>Foto Selesai</label>
                    <div id="preview-selesai" class="image-preview"></div>
                    <div class="form-buttons">
                        <button type="button" class="btn-location btn-camera" data-target-input="foto-selesai">Ambil Foto (Kamera)</button>
                        <button type="button" class="btn-location btn-gallery" data-target-input="foto-selesai">Pilih dari Galeri</button>
                    </div>
                    <input type="file" id="foto-selesai" accept="image/*" style="display: none;">
                </div>
                <div class="form-group hidden" id="lama-pengerjaan-group">
                    <label for="lama-pengerjaan">Lama Pengerjaan:</label>
                    <input type="text" id="lama-pengerjaan" placeholder="Contoh: 8 Jam">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn-save">Simpan Data</button>
                    <button type="button" id="btn-cancel" class="btn-cancel">Batal</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script>
        // Kode JavaScript Anda tidak perlu diubah dari versi sebelumnya
        // Pastikan Anda sudah menggunakan kode JS dari respons saya yang terakhir
        document.addEventListener('DOMContentLoaded', async () => { const navLinks = document.querySelectorAll('.nav-link'); const views = document.querySelectorAll('.view'); const formTitle = document.getElementById('form-title'); const navLinkAdd = document.querySelector('.nav-link[data-target="form-view"]'); function switchView(targetId, isEditing = false) { views.forEach(view => view.classList.add('hidden')); document.getElementById(targetId).classList.remove('hidden'); navLinks.forEach(link => { link.classList.toggle('active', link.dataset.target === targetId); }); if (targetId === 'form-view') { formTitle.textContent = isEditing ? 'Edit Data Kegiatan' : 'Tambah Data Kegiatan'; navLinkAdd.textContent = isEditing ? 'Edit Data' : 'Tambah Data Baru'; } } navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = e.target.dataset.target; if (targetId === 'form-view' && document.getElementById('kegiatan-id').value !== '') { clearForm(); } switchView(targetId); }); }); const btnIsiPersonil = document.getElementById('btn-isi-personil-lengkap'); const inputPetugas = document.getElementById('petugas'); btnIsiPersonil.addEventListener('click', () => { inputPetugas.value = ['Simri', 'Very', 'Musa', 'Suleman', 'Agrifan', 'Russel', 'Darwin', 'Frans'].join(', '); }); const form = document.getElementById('kegiatan-form'); let sqlDB; let idb; function initIDB() { return new Promise((resolve, reject) => { const request = indexedDB.open('ImageDatabase', 1); request.onerror = event => reject("Gagal membuka IndexedDB."); request.onsuccess = event => resolve(event.target.result); request.onupgradeneeded = event => { const db = event.target.result; db.createObjectStore('images', { keyPath: 'id' }); }; }); } function saveImageToIDB(id, blob) { return new Promise((resolve, reject) => { const transaction = idb.transaction(['images'], 'readwrite'); const store = transaction.objectStore('images'); const request = store.put({ id, blob }); transaction.oncomplete = () => resolve(id); transaction.onerror = event => reject("Gagal menyimpan gambar: " + event.target.error); }); } function getImageFromIDB(id) { return new Promise((resolve, reject) => { if (!id) return resolve(null); const transaction = idb.transaction(['images'], 'readonly'); const store = transaction.objectStore('images'); const request = store.get(id); request.onsuccess = event => resolve(event.target.result ? event.target.result.blob : null); request.onerror = event => reject("Gagal mengambil gambar: " + event.target.error); }); } async function initSqlDB() { const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` }); const savedDb = localStorage.getItem('sqlite_db_meta'); const db = savedDb ? new SQL.Database(new Uint8Array(JSON.parse(savedDb))) : new SQL.Database(); db.run(`CREATE TABLE IF NOT EXISTS kegiatan (id INTEGER PRIMARY KEY, tanggal TEXT, nama_kegiatan TEXT, lokasi TEXT, petugas TEXT, lama_pengerjaan TEXT, titik_koordinat TEXT, desa TEXT, kelurahan TEXT, kecamatan TEXT, kabupaten TEXT, foto_sebelum_id TEXT, foto_sementara_id TEXT, foto_selesai_id TEXT);`); return db; } function updateDateRangeHeader() { const stmt = sqlDB.prepare("SELECT tanggal FROM kegiatan WHERE tanggal IS NOT NULL AND tanggal != ''"); const dates = []; while (stmt.step()) { dates.push(new Date(stmt.get()[0] + 'T00:00:00')); } stmt.free(); const dateRangeEl = document.getElementById('dynamic-date-range'); if (dates.length === 0) { dateRangeEl.textContent = 'LAPORAN KINERJA'; return; } const minDate = new Date(Math.min.apply(null, dates)); const maxDate = new Date(Math.max.apply(null, dates)); const bulanIndonesia = ['JANUARI', 'FEBRUARI', 'MARET', 'APRIL', 'MEI', 'JUNI', 'JULI', 'AGUSTUS', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DESEMBER']; const minMonth = bulanIndonesia[minDate.getMonth()]; const maxMonth = bulanIndonesia[maxDate.getMonth()]; const year = maxDate.getFullYear(); dateRangeEl.textContent = (minMonth === maxMonth && minDate.getFullYear() === maxDate.getFullYear()) ? `${maxMonth} ${year}` : `${minMonth} - ${maxMonth} ${year}`; } async function renderTable() { const tbody = document.getElementById('kegiatan-list'); tbody.innerHTML = ''; const stmt = sqlDB.prepare("SELECT * FROM kegiatan ORDER BY id ASC"); let results = []; while (stmt.step()) results.push(stmt.getAsObject()); stmt.free(); for (let i = 0; i < results.length; i++) { const rowData = results[i]; const rowNumber = i + 1; const [imgSebelum, imgSementara, imgSelesai] = await Promise.all([getImageFromIDB(rowData.foto_sebelum_id), getImageFromIDB(rowData.foto_sementara_id), getImageFromIDB(rowData.foto_selesai_id)]); const tr1 = document.createElement('tr'); tr1.innerHTML = `<td rowspan="2" class="number-cell editable" data-id="${rowData.id}" title="Klik untuk mengedit data ini">${rowNumber}</td> <td class="image-cell"><img src="${blobToUrl(imgSebelum)}" alt="Foto Sebelum"></td> <td class="image-cell"><img src="${blobToUrl(imgSementara)}" alt="Foto Sementara"></td> <td class="image-cell"><img src="${blobToUrl(imgSelesai)}" alt="Foto Selesai"></td>`; const tr2 = document.createElement('tr'); const mapsLink = rowData.titik_koordinat ? `<a href="https://www.google.com/maps?q=${rowData.titik_koordinat}" target="_blank">${rowData.titik_koordinat}</a>` : ''; const addressParts = [rowData.desa, rowData.kelurahan, rowData.kecamatan, rowData.kabupaten].filter(Boolean).join(', '); let fullAddressString = mapsLink; if (addressParts) { fullAddressString += (mapsLink ? ', ' : '') + addressParts; } if (!fullAddressString) { fullAddressString = 'Tidak ada data'; } tr2.innerHTML = `<td colspan="3" class="details-cell"><table class="details-table"><tr><td class="label-col">Tanggal</td><td class="colon-col">:</td><td>${new Date(rowData.tanggal + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}</td></tr><tr><td class="label-col">Nama Kegiatan</td><td class="colon-col">:</td><td>${rowData.nama_kegiatan || ''}</td></tr><tr><td class="label-col">Lokasi (Deskripsi)</td><td class="colon-col">:</td><td>${rowData.lokasi || ''}</td></tr><tr><td class="label-col">Titik Koordinat & Alamat</td><td class="colon-col">:</td><td>${fullAddressString}</td></tr><tr><td class="label-col">Petugas</td><td class="colon-col">:</td><td>${rowData.petugas || ''}</td></tr><tr><td class="label-col">Lama Pengerjaan</td><td class="colon-col">:</td><td>${rowData.lama_pengerjaan || ''}</td></tr><tr class="no-print"><td colspan="3" style="text-align: right; padding-top: 10px;"><button type="button" class="btn-share-wa" data-id="${rowData.id}">Bagikan ke WhatsApp</button></td></tr></table></td>`; tbody.appendChild(tr1); tbody.appendChild(tr2); } updateDateRangeHeader(); } function clearForm() { form.reset(); document.getElementById('kegiatan-id').value = ''; document.getElementById('location-status').textContent = ''; ['sebelum', 'sementara', 'selesai'].forEach(key => { document.getElementById(`preview-${key}`).innerHTML = ''; }); document.getElementById('lama-pengerjaan-group').classList.add('hidden'); } document.getElementById('form-view').addEventListener('click', (e) => { const isCameraButton = e.target.classList.contains('btn-camera'); const isGalleryButton = e.target.classList.contains('btn-gallery'); if (isCameraButton || isGalleryButton) { const targetInputId = e.target.dataset.targetInput; const fileInput = document.getElementById(targetInputId); if (isCameraButton) { fileInput.setAttribute('capture', 'user'); } else { fileInput.removeAttribute('capture'); } fileInput.click(); } }); form.addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('kegiatan-id').value; const data = { tanggal: document.getElementById('tanggal').value, nama_kegiatan: document.getElementById('nama-kegiatan').value, lokasi: document.getElementById('lokasi').value, petugas: document.getElementById('petugas').value, lama_pengerjaan: document.getElementById('lama-pengerjaan').value, titik_koordinat: document.getElementById('titik-koordinat').value, desa: document.getElementById('desa').value, kelurahan: document.getElementById('kelurahan').value, kecamatan: document.getElementById('kecamatan').value, kabupaten: document.getElementById('kabupaten').value }; const photoIDs = { foto_sebelum_id: null, foto_sementara_id: null, foto_selesai_id: null }; for (const key of ['sebelum', 'sementara', 'selesai']) { const fileInput = document.getElementById(`foto-${key}`); if (fileInput.files[0]) { const imageBlob = await readFileAsBlob(fileInput.files[0]); const newId = crypto.randomUUID(); photoIDs[`foto_${key}_id`] = await saveImageToIDB(newId, imageBlob); } else if (id) { photoIDs[`foto_${key}_id`] = fileInput.dataset.existingId || null; } } if (id) { sqlDB.run(`UPDATE kegiatan SET tanggal=?, nama_kegiatan=?, lokasi=?, petugas=?, lama_pengerjaan=?, titik_koordinat=?, desa=?, kelurahan=?, kecamatan=?, kabupaten=?, foto_sebelum_id=?, foto_sementara_id=?, foto_selesai_id=? WHERE id=?`, [...Object.values(data), photoIDs.foto_sebelum_id, photoIDs.foto_sementara_id, photoIDs.foto_selesai_id, id]); } else { sqlDB.run(`INSERT INTO kegiatan (tanggal, nama_kegiatan, lokasi, petugas, lama_pengerjaan, titik_koordinat, desa, kelurahan, kecamatan, kabupaten, foto_sebelum_id, foto_sementara_id, foto_selesai_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, [...Object.values(data), photoIDs.foto_sebelum_id, photoIDs.foto_sementara_id, photoIDs.foto_selesai_id]); } localStorage.setItem('sqlite_db_meta', JSON.stringify(Array.from(sqlDB.export()))); await renderTable(); clearForm(); switchView('report-view'); }); document.getElementById('kegiatan-list').addEventListener('click', async (e) => { const isEditButton = e.target.classList.contains('number-cell'); const isShareButton = e.target.classList.contains('btn-share-wa'); if (!isEditButton && !isShareButton) return; if (isEditButton) { const id = e.target.dataset.id; if (confirm('Apakah Anda ingin mengedit data ini?')) { const stmt = sqlDB.prepare("SELECT * FROM kegiatan WHERE id = ?"); stmt.bind([id]); if (stmt.step()) { const data = stmt.getAsObject(); document.getElementById('kegiatan-id').value = data.id; document.getElementById('tanggal').value = data.tanggal; document.getElementById('nama-kegiatan').value = data.nama_kegiatan; document.getElementById('lokasi').value = data.lokasi; document.getElementById('petugas').value = data.petugas; document.getElementById('lama-pengerjaan').value = data.lama_pengerjaan; document.getElementById('titik-koordinat').value = data.titik_koordinat || ''; document.getElementById('desa').value = data.desa || ''; document.getElementById('kelurahan').value = data.kelurahan || ''; document.getElementById('kecamatan').value = data.kecamatan || ''; document.getElementById('kabupaten').value = data.kabupaten || ''; document.getElementById('lokasi-lengkap').value = buildLocationString(data); for (const key of ['sebelum', 'sementara', 'selesai']) { const imageId = data[`foto_${key}_id`]; document.getElementById(`foto-${key}`).dataset.existingId = imageId || ''; const imageBlob = await getImageFromIDB(imageId); const previewContainer = document.getElementById(`preview-${key}`); previewContainer.innerHTML = imageBlob ? `<img src="${blobToUrl(imageBlob)}" alt="Pratinjau ${key}">` : ''; } if (data.foto_selesai_id) { document.getElementById('lama-pengerjaan-group').classList.remove('hidden'); } else { document.getElementById('lama-pengerjaan-group').classList.add('hidden'); } switchView('form-view', true); } stmt.free(); } } if (isShareButton) { e.preventDefault(); const id = e.target.dataset.id; const button = e.target; const originalButtonText = button.textContent; const stmt = sqlDB.prepare("SELECT * FROM kegiatan WHERE id = ?"); stmt.bind([id]); if (!stmt.step()) { stmt.free(); alert('Data tidak ditemukan!'); return; } const data = stmt.getAsObject(); stmt.free(); const tanggalFormatted = new Date(data.tanggal + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); let pesan = `*Laporan Kinerja Transmisi & Instalasi*\n\n`; pesan += `*Tanggal:*\n${tanggalFormatted}\n\n`; pesan += `*Nama Kegiatan:*\n${data.nama_kegiatan}\n\n`; pesan += `*Lokasi (Deskripsi):*\n${data.lokasi}\n\n`; if (data.titik_koordinat) { pesan += `*Titik Koordinat:*\nhttps://www.google.com/maps?q=${data.titik_koordinat}\n\n`; } pesan += `*Petugas:*\n${data.petugas}\n\n`; pesan += `*Lama Pengerjaan:*\n${data.lama_pengerjaan}`; if (navigator.share && navigator.canShare) { button.disabled = true; button.textContent = 'Mempersiapkan...'; try { const [blobSebelum, blobSementara, blobSelesai] = await Promise.all([getImageFromIDB(data.foto_sebelum_id), getImageFromIDB(data.foto_sementara_id), getImageFromIDB(data.foto_selesai_id)]); const files = []; if (blobSebelum) files.push(new File([blobSebelum], "sebelum.jpg", { type: blobSebelum.type })); if (blobSementara) files.push(new File([blobSementara], "sementara.jpg", { type: blobSementara.type })); if (blobSelesai) files.push(new File([blobSelesai], "selesai.jpg", { type: blobSelesai.type })); if (navigator.canShare({ files: files })) { await navigator.share({ title: 'Laporan Kinerja', text: pesan, files: files }); } else { await navigator.share({ title: 'Laporan Kinerja', text: pesan }); } } catch (error) { console.error('Gagal berbagi:', error); } finally { button.disabled = false; button.textContent = originalButtonText; } } else { alert('Fitur berbagi tidak didukung di browser ini. Hanya teks yang akan disalin.'); const encodedPesan = encodeURIComponent(pesan + "\n\n(Gambar tidak dapat dilampirkan dari browser ini)"); window.open(`https://wa.me/?text=${encodedPesan}`, '_blank'); } } }); 
            ['sebelum', 'sementara', 'selesai'].forEach(key => { const fileInput = document.getElementById(`foto-${key}`); fileInput.addEventListener('change', (event) => { const file = event.target.files[0]; const previewContainer = document.getElementById(`preview-${key}`); previewContainer.innerHTML = ''; if (file) { previewContainer.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Pratinjau Baru ${key}">`; } if (key === 'selesai' && file) { document.getElementById('lama-pengerjaan-group').classList.remove('hidden'); } }); });
            document.getElementById('btn-cancel').addEventListener('click', () => { clearForm(); switchView('report-view'); }); document.getElementById('print-button').addEventListener('click', () => window.print()); function readFileAsBlob(file) { return new Promise((resolve, reject) => { if (!file) resolve(null); resolve(new Blob([file], { type: file.type })); }); } function blobToUrl(blobData) { return blobData ? URL.createObjectURL(blobData) : ''; } function buildLocationString(data) { return [data.titik_koordinat, data.desa, data.kelurahan, data.kecamatan, data.kabupaten].filter(Boolean).join(', '); } const getLocationBtn = document.getElementById('get-location-btn'); const locationStatus = document.getElementById('location-status'); getLocationBtn.addEventListener('click', () => { if (!navigator.geolocation) { locationStatus.textContent = 'Geolocation tidak didukung oleh browser ini.'; return; } locationStatus.textContent = 'Meminta akses lokasi...'; getLocationBtn.disabled = true; const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }; navigator.geolocation.getCurrentPosition(handleSuccess, handleError, options); }); async function handleSuccess(position) { const { latitude: lat, longitude: lon } = position.coords; const locationData = { titik_koordinat: `${lat},${lon}`, desa: '', kelurahan: '', kecamatan: '', kabupaten: '' }; document.getElementById('titik-koordinat').value = locationData.titik_koordinat; if (navigator.onLine) { locationStatus.textContent = `Koordinat didapat. Mengambil detail alamat online...`; try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`); if (!response.ok) throw new Error('Gagal menghubungi server alamat.'); const data = await response.json(); const addr = data.address; locationData.desa = addr.village || ''; locationData.kelurahan = addr.suburb || ''; locationData.kecamatan = addr.city_district || addr.subdistrict || ''; locationData.kabupaten = addr.county || addr.city || ''; locationStatus.textContent = 'Detail alamat online berhasil didapatkan!'; } catch (error) { console.error("Gagal mengambil alamat online:", error); locationStatus.innerHTML = `<b>Koordinat berhasil didapat.</b><br>Gagal mengambil nama alamat, silakan isi manual.`; } } else { locationStatus.innerHTML = `<b>Mode Offline: Koordinat berhasil didapat.</b><br>Silakan isi detail alamat secara manual.`; } document.getElementById('desa').value = locationData.desa; document.getElementById('kelurahan').value = locationData.kelurahan; document.getElementById('kecamatan').value = locationData.kecamatan; document.getElementById('kabupaten').value = locationData.kabupaten; document.getElementById('lokasi-lengkap').value = buildLocationString(locationData); getLocationBtn.disabled = false; } function handleError(error) { getLocationBtn.disabled = false; switch (error.code) { case error.PERMISSION_DENIED: locationStatus.innerHTML = "<b>Akses lokasi ditolak.</b><br>Periksa izin lokasi untuk situs ini di pengaturan browser Anda."; break; case error.POSITION_UNAVAILABLE: locationStatus.textContent = "Informasi lokasi tidak tersedia. Coba aktifkan GPS."; break; case error.TIMEOUT: locationStatus.textContent = "Waktu permintaan lokasi habis. Coba lagi di tempat dengan sinyal lebih baik."; break; default: locationStatus.textContent = "Terjadi kesalahan tidak dikenal saat mengambil lokasi."; break; } }
            (async () => { try { [sqlDB, idb] = await Promise.all([initSqlDB(), initIDB()]); document.getElementById('loading-status').style.display = 'none'; await renderTable(); switchView('report-view'); } catch (err) { console.error("Gagal memulai aplikasi:", err); document.getElementById('loading-status').innerText = "Gagal memulai aplikasi. Lihat konsol untuk detail."; } })();
        });
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('PWA ServiceWorker berhasil didaftarkan: ', registration.scope);
          }).catch(error => {
            console.log('Pendaftaran ServiceWorker gagal: ', error);
          });
        });
      }
    </script>
</body>
</html>
